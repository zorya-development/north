name: test

on:
  push:
    branches: [master]
  pull_request:

env:
  CARGO_TERM_COLOR: always
  REGISTRY: ghcr.io
  BASE_IMAGE: ghcr.io/zorya-development/north/base

jobs:
  resolve:
    name: Resolve base image
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.tag }}
      base_changed: ${{ steps.changes.outputs.base }}
    steps:
      - uses: actions/checkout@v4

      - name: Read version
        id: version
        run: echo "tag=$(cat docker/base/VERSION | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            base:
              - 'docker/base/**'

  build-base:
    name: Build Base Image
    needs: [resolve]
    if: needs.resolve.outputs.base_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: docker/base
          push: true
          provenance: false
          tags: ${{ env.BASE_IMAGE }}:${{ needs.resolve.outputs.version }}

  check:
    name: Check
    needs: [resolve, build-base]
    if: always() && needs.resolve.result == 'success' && needs.build-base.result != 'failure'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zorya-development/north/base:${{ needs.resolve.outputs.version }}

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: north_test
          POSTGRES_USER: north
          POSTGRES_PASSWORD: north
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://north:north@postgres:5432/north_test
      JWT_SECRET: test-secret
      UPLOAD_DIR: /tmp/north-uploads

    steps:
      - uses: actions/checkout@v4

      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: "true"
          shared-key: north-cargo

      - name: Run migrations
        run: diesel migration run

      - name: Format check
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy -- -D warnings

      - name: Test
        run: cargo test
