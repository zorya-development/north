# CLAUDE.md

This file provides guidance to Claude Code when working with code in this repository.

## Build & Development Commands

Start dependencies, then enter the app container:

```bash
docker compose up -d db redis
docker compose run --rm -ti --service-ports app bash
```

Inside the container, use `just` commands:

```bash
just dev               # Run dev server (cargo-leptos watch)
just test              # Run all tests
just test crate_name   # Run tests for specific crate
just fmt               # Format code
just lint              # cargo clippy
just migrate           # Apply migrations (diesel)
just migration name    # Create new migration
just migration-diff n  # Create migration via schema diff
just migrate-revert    # Revert last migration
just migrate-redo      # Revert + reapply last migration
just build             # Release build
just seed              # Seed admin account
just check             # fmt + lint + test
```

For non-interactive / CI use: `docker compose exec app just <command>`

## Architecture Overview

GTD-inspired task management system. Single Rust binary serving SSR + WASM via Leptos 0.7 + Axum.

### Dependency Graph

```
domain  (pure data types, no IO)
  ↑
  db    (Diesel schema, models, pool type — depends on domain)
  ↑
services (business logic — depends on db + domain)
  ↑        ↑
  app      server  (both depend on services)
  ↑
  ui    (generic UI components — depends on leptos only)
```

### Data Flow

```
Browser → Axum Router
  ├── /api/*  → REST API handlers (server crate, auth via JWT middleware)
  │              → calls services → Diesel queries → DB
  └── /*      → Leptos SSR → server functions (app crate)
                             → calls services → Diesel queries → DB
                           → hydrated WASM on client
```

## Project Structure

```
north/
├── Cargo.toml                  # Workspace config (resolver 2)
├── rust-toolchain.toml         # Stable + wasm32-unknown-unknown
├── diesel.toml                 # Diesel CLI config (schema.rs path)
├── justfile                    # Dev commands (see above)
├── docker-compose.yml          # app, PostgreSQL 17, Redis 7
├── docker/dev/Dockerfile       # Rust 1.93, cargo-leptos, diesel_cli, tailwindcss v4
├── migrations/                 # Diesel reversible migrations (up.sql + down.sql)
├── style/main.css              # TailwindCSS v4, dark theme, Inter + JetBrains Mono
├── public/                     # Static assets served at /public
├── uploads/                    # User-uploaded files (volume mount)
├── docs/                       # PRD.md, DESIGN.md
├── .github/workflows/ci.yml   # GitHub Actions CI
│
└── crates/
    ├── domain/                 # Pure data types (no IO)
    │   └── src/
    │       ├── lib.rs
    │       ├── column.rs       # Column, CreateColumn, UpdateColumn
    │       ├── project.rs      # Project, ProjectWithColumns, CreateProject, UpdateProject, ProjectViewType
    │       ├── tag.rs          # Tag, CreateTag, UpdateTag, TagInfo
    │       ├── task.rs         # Task, TaskWithMeta, CreateTask, UpdateTask, MoveTask, TaskFilter
    │       ├── text_parser.rs  # parse_tokens() — extracts #tags and @project from text
    │       └── user.rs         # User, UserRole, UserSettings, DefaultColumn, auth DTOs
    │
    ├── db/                     # Diesel infrastructure (schema, models, pool type)
    │   └── src/
    │       ├── lib.rs          # DbPool type alias, DbError, DbResult
    │       ├── schema.rs       # Auto-generated by diesel print-schema
    │       ├── sql_types.rs    # PG enum mappings (UserRoleMapping, ProjectViewTypeMapping)
    │       └── models/
    │           ├── mod.rs
    │           ├── user.rs     # UserRow, NewUser
    │           ├── project.rs  # ProjectRow, NewProject, ProjectChangeset
    │           ├── column.rs   # ColumnRow, NewColumn, ColumnChangeset
    │           ├── task.rs     # TaskRow, NewTask, TaskChangeset
    │           ├── tag.rs      # TagRow, NewTag
    │           ├── task_tag.rs # TaskTagRow, NewTaskTag
    │           └── image.rs    # ImageRow, NewImage
    │
    ├── services/               # Business logic layer
    │   └── src/
    │       ├── lib.rs          # ServiceError, ServiceResult, re-exports (DbPool, services)
    │       ├── task_service.rs # CRUD, enrich(), actionable computation, filtering
    │       ├── project_service.rs # CRUD, columns, archive/unarchive
    │       ├── tag_service.rs  # CRUD, sync_task_tags (full replace), add_task_tags (additive)
    │       ├── column_service.rs # CRUD, task reassignment on delete
    │       ├── user_service.rs # Auth lookup, settings, admin creation
    │       └── stats_service.rs # Aggregated statistics
    │
    ├── ui/                     # Generic UI component library (north-ui)
    │   └── src/
    │       ├── lib.rs              # Re-exports all components
    │       ├── icon.rs             # Icon, IconKind (SVG icon enum)
    │       ├── dropdown.rs         # DropdownMenu, DropdownItem
    │       ├── popover.rs          # Popover (trigger + overlay + positioned panel)
    │       ├── checkbox.rs         # Checkbox (checked + on_toggle callback)
    │       ├── markdown.rs         # MarkdownView + render_markdown()
    │       └── autocomplete.rs     # AutocompleteDropdown, SuggestionItem
    │
    ├── app/                    # Leptos library (SSR + WASM hydration)
    │   └── src/
    │       ├── lib.rs          # hydrate() entry point, recursion_limit = 256
    │       ├── app.rs          # Shell, App component, router setup
    │       ├── pages/
    │       │   ├── login.rs    # LoginPage + login() server function
    │       │   ├── inbox.rs    # InboxPage
    │       │   ├── today.rs    # TodayPage (tasks with start_at <= now)
    │       │   ├── all_tasks.rs # AllTasksPage
    │       │   ├── project.rs  # ProjectPage (tasks for a single project, :id param)
    │       │   ├── archive.rs  # ArchivePage (archived projects, unarchive/delete)
    │       │   ├── review.rs   # ReviewPage (GTD-style task review)
    │       │   └── settings.rs # SettingsPage (user preferences)
    │       ├── components/
    │       │   ├── task_card/          # Container/view pattern
    │       │   │   ├── container.rs    # Signals, handlers, concrete Callback props
    │       │   │   └── view.rs         # Pure rendering (uses north_ui components)
    │       │   ├── task_list/          # Container/view pattern
    │       │   │   ├── container.rs    # Store → callback extraction
    │       │   │   └── view.rs         # Suspense + list rendering
    │       │   ├── date_picker/        # Container/view pattern
    │       │   │   ├── container.rs    # Popover state signals
    │       │   │   └── view.rs         # Uses north_ui::Popover
    │       │   ├── project_picker/     # Container/view pattern
    │       │   │   ├── container.rs    # Project selection state
    │       │   │   └── view.rs         # Uses north_ui::Popover
    │       │   ├── tag_picker/         # Container/view pattern
    │       │   │   ├── container.rs    # Tag selection + creation state
    │       │   │   └── view.rs         # Uses north_ui::Popover
    │       │   ├── autocomplete/       # Container/view pattern
    │       │   │   ├── container.rs    # Autocomplete state, keyboard nav
    │       │   │   └── view.rs         # Re-exports north_ui::{AutocompleteDropdown, SuggestionItem}
    │       │   ├── task_meta.rs        # Pure view (date, project, tags display)
    │       │   ├── task_form.rs        # Self-contained form widget
    │       │   ├── layout.rs           # AppLayout (sidebar + main, auth guard)
    │       │   └── nav.rs              # Sidebar navigation (project links, archive)
    │       ├── stores/
    │       │   ├── task_store.rs       # TaskStore: actions, effects, Callback fields
    │       │   └── lookup_store.rs     # LookupStore: cached projects + tags for pickers
    │       └── server_fns/
    │           ├── auth.rs     # check_auth(), get_auth_user_id()
    │           ├── tasks.rs    # Task CRUD → calls north_services::TaskService
    │           ├── projects.rs # Project CRUD → calls north_services::ProjectService
    │           ├── tags.rs     # Tag CRUD → calls north_services::TagService
    │           └── settings.rs # User settings → calls north_services::UserService
    │
    └── server/                 # Axum binary
        └── src/
            ├── main.rs         # Tokio main, Diesel pool, Leptos SSR router
            ├── error.rs        # AppError (NotFound, Unauthorized, Forbidden, BadRequest, Internal, Service)
            ├── seed.rs         # seed_admin() via UserService
            ├── auth/
            │   ├── jwt.rs      # create_token(), validate_token()
            │   └── middleware.rs  # JWT from cookie or Authorization header → AuthUser
            └── routes/
                ├── mod.rs      # public_api_router(), protected_api_router()
                ├── auth.rs     # POST /api/auth/login, /api/auth/logout
                ├── tasks.rs    # CRUD + move + review endpoints → TaskService
                ├── projects.rs # CRUD + column management → ProjectService/ColumnService
                └── stats.rs    # GET /api/stats → StatsService
```

### Crate Details

- **`domain`** — Pure data types with serde + chrono, no IO. Compiled for both server and WASM. Key types: `TaskFilter` (complex query object), `TaskWithMeta` (task + project_title, column_name, tags, subtask_count, actionable), `UserSettings` (review_interval_days, default_sequential_limit, default_columns).
- **`db`** — Diesel infrastructure: `schema.rs` (auto-generated by `diesel print-schema`), model structs (`XxxRow` for reading, `NewXxx` for inserting, `XxxChangeset` for updating), PG enum mappings via `diesel-derive-enum`, `DbPool` type alias for `diesel_async::deadpool::Pool<AsyncPgConnection>`.
- **`services`** — Business logic layer. Each service is a struct with static async methods that use Diesel's query builder directly. Key patterns: `TaskService::enrich()` for batch metadata loading (projects, columns, tags, subtask counts), `compute_actionable()` for sequential task logic in Rust, `into_boxed()` for dynamic filtering. Re-exports `DbPool` so consumers only depend on `north-services`.
- **`ui`** — Generic UI component library (`north-ui`). No domain dependencies — only `leptos`, `pulldown-cmark`, `ammonia`. Components: `Icon`/`IconKind`, `DropdownMenu`/`DropdownItem`, `Popover`, `Checkbox`, `MarkdownView`/`render_markdown()`, `AutocompleteDropdown`/`SuggestionItem`. Used by `app` crate for reusable UI primitives.
- **`app`** — Leptos library crate. Features: `hydrate` (WASM client), `ssr` (server-side, pulls in north-services/argon2/jsonwebtoken). Server functions use `#[server]` macro with DB access via `expect_context::<north_services::DbPool>()`, then delegate to service methods. Domain-specific components import generic UI primitives from `north-ui`.
- **`server`** — Axum binary. Depends on `north-app` with `ssr` feature. Auth middleware injects `AuthUser { id, role }` into request extensions. Route handlers delegate to service methods.

### REST API Routes

```
POST   /api/auth/login        (public)
POST   /api/auth/logout        (public)
GET    /api/tasks              (protected, supports TaskFilter query params)
POST   /api/tasks              (protected)
GET    /api/tasks/:id          (protected)
PATCH  /api/tasks/:id          (protected)
DELETE /api/tasks/:id          (protected)
PATCH  /api/tasks/:id/move     (protected)
PATCH  /api/tasks/:id/review   (protected)
GET    /api/projects           (protected)
POST   /api/projects           (protected)
GET    /api/projects/:id       (protected)
PATCH  /api/projects/:id       (protected)
DELETE /api/projects/:id       (protected, archives the project)
POST   /api/projects/:id/columns (protected)
PATCH  /columns/:id            (protected)
DELETE /columns/:id            (protected)
GET    /api/stats              (protected)
```

## Data Models

```
users (email, password_hash, name, role ENUM, settings JSONB, created_at, updated_at)
├── projects (title, description, color, view_type ENUM, position, archived, created_at, updated_at)
│   ├── project_columns (name, color, position, is_done, created_at)
│   └── tasks (title, body, position, sequential_limit, start_at, due_date, completed_at, reviewed_at, ...)
│       ├── tasks (subtasks via parent_id self-reference)
│       └── task_tags → tags (join table)
├── tags (name, color, UNIQUE per user)
└── images (path, filename, content_type, size_bytes)
```

DB enums: `user_role` (admin, user), `project_view_type` (list, kanban).
Triggers: `update_updated_at()` on users, projects, tasks.

## Key Patterns

- **Auth:** JWT (7-day expiry) in httpOnly cookie. REST API also accepts `Authorization: Bearer` header. Server functions extract auth via `leptos_axum::extract()`. Password hashing with Argon2.
- **Sequential tasks:** `tasks.sequential_limit` controls how many subtasks are actionable. Computed in Rust via `compute_actionable()`, not SQL window functions.
- **Custom columns:** Each project has its own columns (statuses). Created from user's `default_columns` setting.
- **Data access:** Diesel ORM with `diesel-async` for async PostgreSQL. Service layer uses Diesel query builder directly (no repository abstraction). Batch metadata loading via `enrich()` to avoid N+1 queries.
- **Container/view pattern:** Components with state management are split into directories: `container.rs` (signals, handlers, callback wiring) and `view.rs` (pure rendering). Pure presentational components stay as single files. Containers use concrete `Callback<T>` types, not generic type params.
- **TaskStore:** Centralized controller (`stores/task_store.rs`) that owns actions and effects for task mutations (complete, delete, update, set/clear start_at). Pages create a `TaskStore` from a `Resource` and pass it to `TaskList`.
- **LookupStore:** Cached projects and tags loaded once and shared across pickers (`stores/lookup_store.rs`).
- **Token parsing:** `parse_tokens()` in domain crate extracts `#tags` and `@project` references from task title/body text. Services resolve these to DB records.

## Code Conventions

- **Rust edition 2021**, stable toolchain
- **Type hints** on all public functions
- **Imports** — grouped: std → external crates → local crates, sorted alphabetically
- **Error handling** — use `thiserror` for domain errors, `anyhow` avoided. Services return `ServiceResult<T>`, routes convert via `From<ServiceError> for AppError`
- **Test files** — `_test.rs` suffix or `tests/` module, standard Rust conventions
- **Logging** — `tracing` crate, never `println!` for errors/info
- **Time** — always `chrono::Utc`, never naive datetimes
- **No inline comments for obvious code**
- **Line length** — 100 characters preferred
- **Diesel models** — `XxxRow` (Queryable, Selectable), `NewXxx` (Insertable), `XxxChangeset` (AsChangeset). `From<XxxRow> for DomainType` conversions.

## Common Workflows

### Add New Domain Type
1. Create type file in `crates/domain/src/`
2. Export in `crates/domain/src/lib.rs`
3. Create migration: `just migration name`
4. Write `up.sql` and `down.sql`
5. Run `just migrate` (auto-updates `schema.rs`)
6. Add model structs in `crates/db/src/models/`
7. Add service methods in `crates/services/src/`

### Add New Page
1. Create page component in `crates/app/src/pages/`
2. Export in `crates/app/src/pages/mod.rs`
3. Add server functions in `crates/app/src/server_fns/`
4. Register route in `crates/app/src/app.rs`
5. Add nav item in `crates/app/src/components/nav.rs`
6. For task-based pages: create `Resource`, `TaskStore`, pass to `TaskList`

### Add New UI Primitive
1. Create component file in `crates/ui/src/`
2. Export in `crates/ui/src/lib.rs`
3. No domain dependencies — only `leptos` and rendering libs

### Add New Component (with state)
1. Create directory `crates/app/src/components/<name>/`
2. `container.rs` — signals, handlers, concrete `Callback` props (no generics)
3. `view.rs` — pure rendering, receives data + handlers as props
4. `mod.rs` — `pub use container::ComponentName;`
5. Export in `crates/app/src/components/mod.rs`
6. Import generic UI primitives from `north_ui` (Icon, Dropdown, Popover, etc.)

Pure presentational components (no internal state management) stay as single files.

### Add New REST Endpoint
1. Add handler in `crates/server/src/routes/`
2. Register in router in `crates/server/src/routes/mod.rs`
3. Protect with auth middleware if needed

### Add New Migration
```bash
just migration add_due_reminders  # Creates migrations/YYYY-MM-DD-NNNNNN_add_due_reminders/
# Edit up.sql and down.sql
just migrate                       # Applies migration, updates schema.rs
just migrate-redo                  # Test reversibility
```

## Infrastructure

- PostgreSQL 17, Redis 7 (Redis reserved for future use)
- Docker Compose for development (all commands via `docker compose exec app`)
- Diesel ORM with diesel-async for async PostgreSQL access
- Images stored on filesystem (`./uploads/` volume mount)
- CI: GitHub Actions — fmt, clippy, test, cargo-leptos release build against PostgreSQL 17 service
